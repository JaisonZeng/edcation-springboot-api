# 头像上传问题解决方案总结

## 问题描述

在教育平台项目中，用户无法成功上传头像。通过详细排查发现，前端虽然能获取JWT令牌并发送请求，但后端在处理上传请求时返回了403 Forbidden错误，表明认证失败。

## 问题分析

经过深入分析，确定了三个主要原因：

1. **配置文件中的上下文路径设置**：在`application.yml`中设置了`server.servlet.context-path: /api`，但部分代码没有相应更新。
2. **静态资源映射路径问题**：在`WebMvcConfig.java`中，静态资源映射使用了绝对路径而非相对路径。
3. **JWT认证中用户ID获取逻辑错误**：`SecurityUtil.getCurrentUserId()`方法试图将UserDetails的username字段解析为Long类型的用户ID，但username实际存储的是用户名字符串。

## 解决方案

### 1. 更新配置文件

修改`application.yml`中的静态资源映射路径，确保与上下文路径一致：

```yaml
spring:
  web:
    resources:
      static-locations: file:./uploads/
```

### 2. 优化静态资源映射配置

修改`WebMvcConfig.java`，将资源位置路径从绝对路径改为相对路径：

```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    String avatarDir = System.getProperty("user.dir") + "/uploads/avatar/";
    registry.addResourceHandler("/avatar/**")
            .addResourceLocations("file:./uploads/avatar/");
}
```

### 3. 修复用户ID获取逻辑

按照方案二实施解决方案：

1. 创建自定义UserDetails类，扩展Spring Security的User类并添加用户ID字段。
2. 修改`CustomUserDetailsService`类，使用新的`CustomUserDetails`类并传递用户ID。
3. 修改`UserServiceImpl`类，在登录方法中使用新的`CustomUserDetails`类。
4. 修改`SecurityUtil`类，从`CustomUserDetails`中直接获取用户ID。

### 4. 更新控制器中的基础URL

修改`UserController.java`中的base-url默认值，添加上下文路径前缀：

```java
@Value("${app.upload.base-url:http://127.0.0.1:8080/api/avatar/}")
private String baseUrl;
```

### 5. 修复配置文件错误

修正`application.yml`中Jackson配置的大小写错误：

```yaml
spring:
  jackson:
    default-property-inclusion: NON_NULL
```

## 验证结果

通过以下步骤验证解决方案的有效性：

1. 重新启动应用程序。
2. 使用有效凭据登录系统。
3. 获取JWT令牌。
4. 使用令牌调用上传头像接口。
5. 验证头像URL是否可正常访问。

最终验证结果显示，头像上传功能恢复正常，用户可以成功上传头像并能通过URL正常访问。

## 总结

该问题的根本原因是JWT认证流程中用户ID获取逻辑的不匹配以及配置文件路径设置的不一致。通过综合修改配置文件、优化静态资源映射、修复用户ID获取逻辑等措施，成功解决了头像上传认证失败的问题。实施的解决方案具有良好的可维护性和扩展性，为系统未来的功能扩展提供了良好的基础。